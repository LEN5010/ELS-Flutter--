# 英语学习系统前端接口文档

## 目录
- [系统概述](#系统概述)
- [认证机制](#认证机制)
- [通用响应格式](#通用响应格式)
- [错误码说明](#错误码说明)
- [接口列表](#接口列表)
  - [用户认证](#用户认证)
  - [用户管理](#用户管理)
  - [学习资源](#学习资源)
  - [测验系统](#测验系统)
  - [社区功能](#社区功能)
  - [管理员功能](#管理员功能)
  - [日志系统](#日志系统)

---

## 系统概述

### 基础信息
- **服务地址**: `http://localhost:5001`
- **API前缀**: `/api`
- **数据库**: MySQL (业务数据) + MongoDB (日志数据)
- **认证方式**: JWT Token
- **Token有效期**: 7天

### 技术栈
- **后端**: Flask + Python 3.13
- **数据库**: MySQL 8.0 + MongoDB
- **认证**: JWT
- **密码加密**: MySQL存储函数 + 盐值

---

## 认证机制

### Token获取
通过登录接口获取JWT Token，有效期7天。

### Token使用
在请求头中添加：
```
Authorization: Bearer <your_jwt_token>
```

### 权限等级
- **student**: 普通用户，基础学习功能
- **admin**: 管理员，所有功能 + 后台管理

---

## 通用响应格式

### 成功响应
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体数据
  }
}
```

### 错误响应
```json
{
  "code": 400,
  "message": "错误信息",
  "data": null
}
```

---

## 错误码说明

| HTTP状态码 | 说明 |
|-----------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（Token无效或过期） |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 接口列表

### 用户认证

#### 1. 用户注册
```
POST /api/auth/register
```

**请求参数**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "nickname": "用户昵称"  // 可选，默认为邮箱前缀
}
```

**响应示例**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGci...",
    "user_id": 1,
    "email": "user@example.com",
    "nickname": "用户昵称"
  }
}
```

**注意事项**
- 邮箱不能重复
- 系统会自动初始化用户进度记录
- 注册成功后直接返回Token

#### 2. 用户登录
```
POST /api/auth/login
```

**请求参数**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**响应示例**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGci...",
    "user_id": 1,
    "email": "user@example.com",
    "nickname": "用户昵称",
    "role": "student"
  }
}
```

**注意事项**
- 系统会自动记录登录日志（IP地址等）
- 返回的Token需要保存，用于后续请求认证

#### 3. 用户登出
```
POST /api/auth/logout
```

**请求头**
```
Authorization: Bearer <token>
```

**响应示例**
```json
{
  "code": 200,
  "message": "登出成功",
  "data": null
}
```

**注意事项**
- 系统会记录登出日志
- 前端需要清除本地存储的Token

---

### 用户管理

#### 1. 获取用户资料
```
GET /api/user/profile/{user_id}
```

**响应示例**
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "user_id": 1,
    "email": "user@example.com",
    "nickname": "用户昵称",
    "gender": "U",  // M/F/U
    "birthday": "1990-01-01",
    "role": "student",
    "myps": "个人简介",
    "created_at": "2025-09-22T04:55:00"
  }
}
```

#### 2. 更新用户资料
```
PUT /api/user/profile/{user_id}
```

**请求参数**
```json
{
  "nickname": "新昵称",
  "gender": "M",  // M/F/U
  "birthday": "1990-01-01",
  "myps": "个人简介"
}
```

**注意事项**
- 只更新提供的字段
- 至少需要提供一个字段

#### 3. 获取学习进度
```
GET /api/user/progress/{user_id}
```

**响应示例**
```json
{
  "code": 200,
  "data": {
    "progress": {
      "user_id": 1,
      "vocab_learned": 150,
      "grammar_learned": 25,
      "listening_done": 30,
      "last_update": "2025-09-22T04:55:00"
    },
    "quiz_history": [
      {
        "result_id": 1,
        "quiz_id": 1,
        "title": "A1词汇测试",
        "quiz_type": "vocab",
        "score": 85,
        "correct_cnt": 17,
        "total_cnt": 20,
        "taken_at": "2025-09-22T04:55:00"
      }
    ]
  }
}
```

#### 4. 更新学习进度
```
PUT /api/user/progress/{user_id}
```

**请求参数**
```json
{
  "type": "vocab",     // vocab/grammar/listening
  "increment": 1       // 增量，默认为1
}
```

**注意事项**
- 系统会自动更新 `last_update` 时间
- `increment` 可以为负数（减少进度）

---

### 学习资源

#### 1. 获取词汇列表
```
GET /api/learning/vocab
```

**查询参数**
- `level`: 难度等级 (A1/A2/B1/B2/C1/C2)，默认A1
- `page`: 页码，默认1
- `per_page`: 每页数量，默认20

**响应示例**
```json
{
  "code": 200,
  "data": {
    "total": 500,
    "page": 1,
    "per_page": 20,
    "data": [
      {
        "word_id": 1,
        "word": "hello",
        "meaning": "你好",
        "example": "Hello, world!",
        "level": "A1"
      }
    ]
  }
}
```

#### 2. 获取语法教程列表
```
GET /api/learning/grammar
```

**查询参数**
- `level`: 难度等级，默认A1

**响应示例**
```json
{
  "code": 200,
  "data": [
    {
      "grammar_id": 1,
      "title": "现在时态",
      "content": "现在时态的用法说明...",
      "level": "A1"
    }
  ]
}
```

#### 3. 获取听力材料列表
```
GET /api/learning/listening
```

**查询参数**
- `level`: 难度等级，默认A1

**响应示例**
```json
{
  "code": 200,
  "data": [
    {
      "listen_id": 1,
      "title": "日常对话",
      "audio_url": "https://example.com/audio.mp3",
      "transcript": "对话内容...",
      "level": "A1"
    }
  ]
}
```

---

### 测验系统

#### 1. 获取测验列表
```
GET /api/quiz/list
```

**查询参数**
- `type`: 测验类型 (vocab/grammar/listening)，可选

**响应示例**
```json
{
  "code": 200,
  "data": [
    {
      "quiz_id": 1,
      "quiz_type": "vocab",
      "title": "A1词汇测试",
      "total_points": 100
    }
  ]
}
```

#### 2. 获取测验题目
```
GET /api/quiz/{quiz_id}/questions
```

**响应示例**
```json
{
  "code": 200,
  "data": {
    "quiz": {
      "quiz_id": 1,
      "quiz_type": "vocab",
      "title": "A1词汇测试",
      "total_points": 100
    },
    "questions": [
      {
        "question_id": 1,
        "question": "What does 'hello' mean?",
        "option_a": "你好",
        "option_b": "再见",
        "option_c": "谢谢",
        "option_d": "对不起",
        "score": 10
      }
    ]
  }
}
```

**注意事项**
- 题目中不包含正确答案
- 每题的分值在 `score` 字段中

#### 3. 提交测验答案
```
POST /api/quiz/{quiz_id}/submit
```

**请求参数**
```json
{
  "user_id": 1,
  "answers": {
    "1": "A",  // question_id: selected_option
    "2": "B"
  }
}
```

**响应示例**
```json
{
  "code": 200,
  "message": "测验提交成功",
  "data": {
    "score": 85,
    "correct_count": 17,
    "total_count": 20,
    "accuracy": 85.0,
    "level": "Good"  // Excellent/Good/Fair/Poor
  }
}
```

**注意事项**
- 系统使用MySQL函数计算准确率和等级
- 结果会自动保存到用户测验历史

---

### 社区功能

#### 1. 获取帖子列表
```
GET /api/community/posts
```

**查询参数**
- `category`: 分类 (general/question)，可选
- `status`: 状态 (pending/approved/rejected)，仅管理员可用
- `page`: 页码，默认1
- `per_page`: 每页数量，默认20

**响应示例**
```json
{
  "code": 200,
  "data": {
    "total": 100,
    "page": 1,
    "per_page": 20,
    "data": [
      {
        "post_id": 1,
        "user_id": 1,
        "nickname": "用户昵称",
        "title": "学习心得分享",
        "content": "我的学习经验...",
        "category": "general",
        "status": "approved",
        "created_at": "2025-09-22T04:55:00",
        "comment_count": 5
      }
    ]
  }
}
```

#### 2. 获取帖子详情
```
GET /api/community/posts/{post_id}
```

**响应示例**
```json
{
  "code": 200,
  "data": {
    "post": {
      "post_id": 1,
      "user_id": 1,
      "nickname": "用户昵称",
      "title": "学习心得分享",
      "content": "我的学习经验...",
      "category": "general",
      "status": "approved",
      "created_at": "2025-09-22T04:55:00"
    },
    "comments": [
      {
        "comment_id": 1,
        "user_id": 2,
        "nickname": "评论者",
        "content": "很有用的分享！",
        "created_at": "2025-09-22T05:00:00"
      }
    ]
  }
}
```

#### 3. 创建帖子
```
POST /api/community/posts
```

**请求参数**
```json
{
  "user_id": 1,
  "title": "帖子标题",
  "content": "帖子内容",
  "category": "general"  // general/question，默认general
}
```

**响应示例**
```json
{
  "code": 200,
  "message": "帖子创建成功",
  "data": {
    "post_id": 1
  }
}
```

**注意事项**
- 新创建的帖子状态为 `pending`（待审核）
- 需要管理员审核后才会在列表中显示

#### 4. 创建评论
```
POST /api/community/posts/{post_id}/comments
```

**请求参数**
```json
{
  "user_id": 1,
  "content": "评论内容"
}
```

**响应示例**
```json
{
  "code": 200,
  "message": "评论成功",
  "data": {
    "comment_id": 1
  }
}
```

**注意事项**
- 会检查帖子是否存在
- 评论无需审核，直接发布

---

### 管理员功能

> 以下接口需要管理员权限 (role = 'admin')

#### 用户管理

##### 1. 获取所有用户
```
GET /api/admin/users
```

**查询参数**
- `page`: 页码，默认1
- `per_page`: 每页数量，默认20

**响应示例**
```json
{
  "code": 200,
  "data": {
    "total": 1000,
    "page": 1,
    "per_page": 20,
    "data": [
      {
        "user_id": 1,
        "email": "user@example.com",
        "nickname": "用户昵称",
        "gender": "U",
        "role": "student",
        "vocab_learned": 150,
        "grammar_learned": 25,
        "listening_done": 30,
        "created_at": "2025-09-22T04:55:00"
      }
    ]
  }
}
```

##### 2. 更新用户角色
```
PUT /api/admin/users/{user_id}/role
```

**请求参数**
```json
{
  "role": "admin"  // student/admin
}
```

#### 内容审核

##### 1. 获取待审核帖子
```
GET /api/admin/posts/pending
```

**响应示例**
```json
{
  "code": 200,
  "data": [
    {
      "post_id": 1,
      "user_id": 1,
      "nickname": "用户昵称",
      "title": "待审核帖子",
      "content": "帖子内容...",
      "category": "general",
      "status": "pending",
      "created_at": "2025-09-22T04:55:00"
    }
  ]
}
```

##### 2. 审核帖子
```
PUT /api/admin/posts/{post_id}/review
```

**请求参数**
```json
{
  "status": "approved"  // approved/rejected
}
```

#### 学习资源管理

##### 1. 添加词汇
```
POST /api/admin/vocab
```

**请求参数**
```json
{
  "word": "example",
  "meaning": "例子",
  "example": "This is an example.",
  "level": "A1"
}
```

##### 2. 更新词汇
```
PUT /api/admin/vocab/{word_id}
```

**请求参数**
```json
{
  "word": "example",
  "meaning": "例子",
  "example": "This is an example.",
  "level": "A1"
}
```

##### 3. 删除词汇
```
DELETE /api/admin/vocab/{word_id}
```

##### 4. 添加语法教程
```
POST /api/admin/grammar
```

**请求参数**
```json
{
  "title": "现在时态",
  "content": "现在时态的用法...",
  "level": "A1"
}
```

##### 5. 添加听力材料
```
POST /api/admin/listening
```

**请求参数**
```json
{
  "title": "日常对话",
  "audio_url": "https://example.com/audio.mp3",
  "transcript": "对话内容...",
  "level": "A1"
}
```

#### 测验管理

##### 1. 创建测验
```
POST /api/admin/quiz
```

**请求参数**
```json
{
  "quiz_type": "vocab",
  "title": "A1词汇测试",
  "total_points": 100
}
```

##### 2. 添加测验题目
```
POST /api/admin/quiz/{quiz_id}/questions
```

**请求参数**
```json
{
  "question": "What does 'hello' mean?",
  "option_a": "你好",
  "option_b": "再见",
  "option_c": "谢谢",
  "option_d": "对不起",
  "correct_opt": "A",
  "score": 10
}
```

#### 数据统计

##### 1. 获取系统统计
```
GET /api/admin/statistics
```

**响应示例**
```json
{
  "code": 200,
  "data": {
    "users": {
      "total_users": 1000,
      "admin_count": 5,
      "student_count": 995
    },
    "vocab_count": 2000,
    "grammar_count": 150,
    "listening_count": 100,
    "quiz_count": 50,
    "quiz_attempts": 5000,
    "posts": {
      "total_posts": 500,
      "pending_posts": 10,
      "approved_posts": 480
    },
    "comment_count": 2000,
    "today_users": 50
  }
}
```

##### 2. 获取测验成绩统计
```
GET /api/admin/statistics/quiz-performance
```

**响应示例**
```json
{
  "code": 200,
  "data": [
    {
      "quiz_id": 1,
      "title": "A1词汇测试",
      "quiz_type": "vocab",
      "attempt_count": 500,
      "avg_score": 75.5,
      "max_score": 100,
      "min_score": 20,
      "avg_accuracy": 75.5
    }
  ]
}
```

##### 3. 获取用户进度统计
```
GET /api/admin/statistics/user-progress
```

**响应示例**
```json
{
  "code": 200,
  "data": {
    "avg_vocab": 125.5,
    "avg_grammar": 18.2,
    "avg_listening": 22.8,
    "max_vocab": 500,
    "max_grammar": 80,
    "max_listening": 120,
    "active_users_7days": 150
  }
}
```

---

### 日志系统

> 需要登录认证，部分功能需要管理员权限

#### 1. 获取我的活动日志
```
GET /api/logs/my-logs
```

**查询参数**
- `page`: 页码，默认1
- `per_page`: 每页数量，默认20，最大100

**响应示例**
```json
{
  "code": 200,
  "data": {
    "logs": [
      {
        "_id": "60f7b1234567890abcdef123",
        "user_id": 1,
        "nickname": "用户昵称",
        "action_type": "quiz_attempt",
        "timestamp": "2025-09-22T04:55:00.607Z",
        "details": {
          "quiz_id": 1,
          "quiz_title": "A1词汇测试",
          "score": 85,
          "accuracy": 85.0
        }
      }
    ],
    "page": 1,
    "per_page": 20
  }
}
```

#### 2. 获取用户活动日志（管理员）
```
GET /api/logs/user/{user_id}/logs
```

**查询参数**
- `page`: 页码，默认1
- `per_page`: 每页数量，默认20

#### 3. 根据操作类型获取日志（管理员）
```
GET /api/logs/by-action/{action_type}
```

**操作类型包括**
- `user_login` - 用户登录
- `user_logout` - 用户登出
- `quiz_attempt` - 测验尝试
- `learning_progress` - 学习进度
- `post_created` - 帖子创建
- `comment_created` - 评论创建
- `admin_action` - 管理员操作

#### 4. 根据日期范围获取日志（管理员）
```
GET /api/logs/by-date-range
```

**查询参数**
- `start_date`: 开始日期 (ISO格式: 2025-09-22 或 2025-09-22T04:55:00)
- `end_date`: 结束日期
- `user_id`: 用户ID（可选）
- `page`: 页码
- `per_page`: 每页数量

#### 5. 获取日志统计（管理员）
```
GET /api/logs/statistics
```

**查询参数**
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）

**响应示例**
```json
{
  "code": 200,
  "data": {
    "total_logs": 10000,
    "today_logs": 150,
    "action_type_stats": [
      {
        "action_type": "user_login",
        "count": 2000,
        "unique_user_count": 500
      },
      {
        "action_type": "quiz_attempt",
        "count": 5000,
        "unique_user_count": 800
      }
    ]
  }
}
```

#### 6. 手动创建日志
```
POST /api/logs/create
```

**请求参数**
```json
{
  "action_type": "custom_action",
  "details": {
    "description": "自定义操作描述",
    "additional_info": "额外信息"
  }
}
```

#### 7. 记录测验尝试日志
```
POST /api/logs/log-quiz-attempt
```

**请求参数**
```json
{
  "quiz_id": 1,
  "quiz_title": "测验标题",
  "score": 85,
  "accuracy": 85.0
}
```

#### 8. 记录学习进度日志
```
POST /api/logs/log-learning-progress
```

**请求参数**
```json
{
  "content_type": "vocab",  // vocab/grammar/listening
  "content_id": 123,
  "action": "completed"     // started/completed/reviewed
}
```

#### 9. 获取最近活动
```
GET /api/logs/recent-activities
```

**查询参数**
- `limit`: 限制数量，最多50条，默认10

**响应示例**
```json
{
  "code": 200,
  "data": {
    "recent_activities": [
      {
        "_id": "60f7b1234567890abcdef123",
        "user_id": 1,
        "nickname": "用户昵称",
        "action_type": "quiz_attempt",
        "timestamp": "2025-09-22T04:55:00.607Z",
        "details": {
          "quiz_id": 1,
          "quiz_title": "A1词汇测试",
          "score": 85,
          "accuracy": 85.0
        }
      }
    ],
    "limit": 10
  }
}
```

**注意事项**
- 管理员可以看到所有用户最近7天的活动
- 普通用户只能看到自己的活动
